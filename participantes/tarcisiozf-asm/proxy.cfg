global
    maxconn 20000
    daemon
    # Performance tuning
    #nbproc 1
    nbthread 2
    #cpu-map auto:1/1-4 0- 3

    # Connection tuning
    tune.maxaccept 1024
    tune.bufsize 32768
    tune.rcvbuf.client 262144
    tune.rcvbuf.server 262144
    tune.sndbuf.client 262144
    tune.sndbuf.server 262144

defaults
    mode http

    # Reduced timeouts for better throughput
    timeout client 30s
    timeout connect 5s
    timeout server 30s
    timeout http-request 10s
    timeout http-keep-alive 2s

    # Connection optimization
    option http-keep-alive
    option httplog
    option dontlognull
    option redispatch
    retries 2

    # Performance options
    option tcp-smart-accept
    option tcp-smart-connect

frontend frontend
    bind *:80

    # Connection limits per frontend
    maxconn 1000

    # Rate limiting (optional - adjust as needed)
    #stick-table type ip size 100k expire 30s store http_req_rate(10s)
    #http-request track-sc0 src
    # http-request deny if { sc_http_req_rate(0) gt 50 }

    default_backend backend

backend backend
    balance roundrobin

    # Connection optimization
    option http-keep-alive
    #option httpchk GET /health

    # Backend connection limits
    fullconn 800

    # Server configurations with connection limits
    server s1 /sockets/one.sock weight 90 maxconn 720 #check inter 2s fall 3 rise 2
    server s2 /sockets/two.sock weight 10 maxconn 80 #check inter 2s fall 3 rise 2
